# Enable TLSv1.2 for compatibility with older clients for the current session
[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12

# URL to attempt for downloading the CMD file
$DownloadURL = 'https://raw.githubusercontent.com/emreuls7/mr.winls/pasha/pasha_menu.cmd'

try {
    # Attempt to download the CMD file
    $response = Invoke-WebRequest -Uri $DownloadURL -UseBasicParsing
}
catch {
    Write-Error "Failed to download the file from $DownloadURL. Error: $_"
    exit 1
}

# Generate a unique file name using a GUID
$rand = [Guid]::NewGuid().ToString()
$FilePath = "C:\Windows\Temp\psh_$rand.cmd"

# Prepare the content with a prefix
$prefix = "@::: $rand `r`n"
$content = $prefix + $response.Content
Set-Content -Path $FilePath -Value $content

# Set ComSpec variable for the current session in case it's corrupt in the system
$env:ComSpec = "$env:SystemRoot\system32\cmd.exe"

# Execute the CMD file
Start-Process cmd.exe -ArgumentList "/c `"$FilePath`$($args -join ' ')`" -Wait

# Cleanup temporary files
Remove-Item -Path $FilePath -Force -ErrorAction SilentlyContinue
